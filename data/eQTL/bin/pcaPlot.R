#!/usr/bin/Rscript

##  Plot first two principal components, color by metadata column
##  Diego Garrido Mart√≠n
##  15/09/2018

##  Load libraries 

suppressPackageStartupMessages(library(optparse))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(ggplot2))

##  Parse arguments

option_list = list(
  make_option(c("-i", "--input"), type="character",
              help="Name of the file(s) generated by QTLtools pca", metavar="character"),
  make_option(c("-m","--metadata"), type="character", default = NULL,
              help="Metadata file [default %default]", metavar="character"),
  make_option(c("-c","--color"), type="character", default = NULL,
              help="Name of the column to colour the PCA plot [default %default]", metavar="character"),
  make_option(c("-o", "--output"), type="character", 
              help="Output PCA plot in pdf", metavar="character")
) 

opt_parser <- OptionParser(option_list = option_list)
opt <- parse_args(opt_parser) 

if ( is.null(opt$input) ||is.null(opt$output) ){
  print_help(opt_parser)
  stop("Arguments 'input' and 'output' are required\n", call.=FALSE)
} 

##  Run

# Input pca

pcs <- as.data.frame(t(read.table(sprintf("%s.pca", opt$input), header = T)[,-1]))
stats <- read.table(sprintf("%s.pca_stats", opt$input), nrow = 2)[2,-1]


# Color?
if (!is.null(opt$color)){
  if(is.null(opt$metadata)){
  stop("A metadata file should be provided when 'color' is not NULL") 
  }
  metadata <- read.delim(opt$metadata, header = T, check.names = F)
  row.names(metadata) <- metadata[,1]
  metadata[,1] <- NULL
  pcs <- merge(pcs, metadata, by = "row.names")
} else {
  opt$color <- NULL
}


# Plot
pdf(opt$output,  paper = 'a4r', width = 9, height = 9)
 ggplot() + 
 geom_point(data = pcs, aes_string(x = "V1", y = "V2", color = opt$color)) +
 xlab(sprintf("PC1(%0.2f%%)", stats[1]*100)) +
 ylab(sprintf("PC2(%0.2f%%)", stats[2]*100)) + 
 theme_bw() +
 theme(text = element_text(size=18)) 
dev <- dev.off()
